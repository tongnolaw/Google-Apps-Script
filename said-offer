//‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°
function onFormSubmit() {
  
  var tokenE = ["4Yms4F8xCHtjTLUcArH7qKyCue4SWWG8RFPgVFP8la1"];//‡πÇ‡∏ó‡πÄ‡∏Ñ‡πà‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏Å‡∏•‡∏∏‡πà‡∏°Eternal‡∏ï‡∏á
  var token1 = ["paAlZzvjixdaHRpgOzxmVoYFQFd03iqTHzeJ7ddV2RJ"];//‡πÇ‡∏ó‡πÄ‡∏Ñ‡πà‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏û‡∏£‡∏∞‡πÅ‡∏°‡∏Ñ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥

  var form = FormApp.openById('1TCU7mYrWN_gm0BcpFng1E8Ty9klnphr5I7re0v5_Ml8'); 
  var fRes = form.getResponses();
  var formResponse = fRes[fRes.length - 1];
  var itemResponses = formResponse.getItemResponses();
  
  var ss = SpreadsheetApp.openById('1FyT4N3mnM0l9JDxeOhpthD0xwAV8J5pU-594ka6fqUE');
  var sheet = ss.getSheetByName('‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° 1');
  var row = sheet.getActiveRange().getLastRow()+1;

  //‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï‡πÅ‡∏ú‡πà‡∏ô 2 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ä‡∏µ‡∏ï‡πÅ‡∏ú‡πà‡∏ô 1
   var dynamicList = ss.getSheetByName('‡πÅ‡∏ú‡πà‡∏ô2').getRange('A1:A4');
   var rangeRule = SpreadsheetApp.newDataValidation().requireValueInRange(dynamicList).build();
   sheet.getRange(row,7).setDataValidation(rangeRule); //‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ‡∏Ñ‡∏∑‡∏≠ 7
  
  var msg = '\n'+
            itemResponses[3].getResponse().toString().replaceAll("," , "\n")+'\n'+
            '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ' +Utilities.formatDate(new Date(itemResponses[4].getResponse().toString()), "GMT+7", "d/MM/")+
            (Number(Utilities.formatDate(new Date(itemResponses[4].getResponse().toString()), "GMT+7", "yyyy"))+543)+'\n'+
            '‡∏ä‡∏∑‡πà‡∏≠: '+itemResponses[0].getResponse()+'\n'+
            '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£: ' +itemResponses[1].getResponse()+'\n'+
            'Line ID: ' +itemResponses[2].getResponse()+'\n'+
            '‡∏Å‡∏≥‡∏•‡∏±‡∏á '+itemResponses[5].getResponse()+'\n'+
            ss.getUrl();;
  
  sendLineNotify(msg,tokenE);
  sendLineNotify(msg,token1);
}

function sendLineNotify(message,token) {
  var options = {
    "method": "post",
    "payload": "message=" + message,
    "headers": {
    "Authorization": "Bearer " + token }
};

UrlFetchApp.fetch("https://notify-api.line.me/api/notify", options);
}

String.prototype.replaceAll = function(search, replacement) {
        var target = this;
        return target.replace(new RegExp(search, 'g'), replacement);
};

//‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏µ‡∏ï
function approve() {
   var tokenE = "4Yms4F8xCHtjTLUcArH7qKyCue4SWWG8RFPgVFP8la1";//‡πÇ‡∏ó‡πÄ‡∏Ñ‡πà‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏Å‡∏•‡∏∏‡πà‡∏°Eternal‡∏ï‡∏á
   var token2 = "uS5iSh19VaQjF31LIm7geB5acOb0wUn4m2J8LF5aVnZ";//‡πÇ‡∏ó‡πÄ‡∏Ñ‡πà‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏ñ‡∏ß‡∏≤‡∏¢‡∏†‡∏±‡∏ï‡∏ï‡∏≤‡∏´‡∏≤‡∏£
   var ss = SpreadsheetApp.getActiveSpreadsheet();
   var sheet = ss.getActiveSheet();
   var row = sheet.getActiveRange().getRow();
   var cellvalue = sheet.getActiveCell().getValue().toString();

  var name = sheet.getRange(row, 2).getValue();
  var phone = sheet.getRange(row, 3).getValue();
  var lineId = sheet.getRange(row, 4).getValue();
  var objective = sheet.getRange(row, 5).getValue();
  var spritObj = objective.toString().replaceAll(", " , "\n");
  var date = new Date(sheet.getRange(row, 6).getValue());
  // var startDate = new Date(Utilities.formatDate(date, "GMT+7", "MMMM dd, yyyy 10:30:00 Z"));
  // var endDate = new Date(Utilities.formatDate(date, "GMT+7", "MMMM dd, yyyy 11:00:00 Z"));


  
  var thaiDate = Utilities.formatDate(date, "GMT+7", "d/MM/");
  var year = Number(Utilities.formatDate(date, "GMT+7", "yyyy"));
  var thaiYear = year+543;
  var strThaiYear = thaiYear.toString()
  //var time = Utilities.formatDate(new Date(), "GMT+7", "HH:mm");

  var rng = sheet.getRange(row, 5)
  var res = rng.createTextFinder('‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô').findNext();

  var message = '\n'+cellvalue+'‡πÄ‡∏à‡πâ‡∏≤‡∏†‡∏≤‡∏û‡∏Å‡∏•‡πà‡∏≤‡∏ß'+'\n'+
                spritObj+'\n'+
                '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: '+thaiDate+strThaiYear+'\n';
                if(res!==null){
                  message +='‡πÄ‡∏ß‡∏•‡∏≤: 20.30 - 21.00 ‡∏ô.'+'\n';
                }else{
                  message +='‡πÄ‡∏ß‡∏•‡∏≤: 10.30 - 11.00 ‡∏ô.'+'\n';
                }

      message +='‡∏ä‡∏∑‡πà‡∏≠: '+name+'\n'+                   
                '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£: '+phone;
                if (lineId !== null && lineId !== '') {
                   '\n'+'Line: '+lineId;
                }

    //Creates a calendar event using the submitted data
    var calendar = CalendarApp.getCalendarById("gbi61gc9bbr9sg07vkhm8t3vs8@group.calendar.google.com");
    var titles = (name);
    var descriptions =  '‡∏à‡∏≠‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: '+thaiDate+strThaiYear+'\n'+
                        '‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏Ñ‡∏≥‡∏ñ‡∏ß‡∏≤‡∏¢: '+'\n'+
                        spritObj+'\n'+
                        '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£: '+phone+'\n';
                        if (lineId !== null && lineId !== '') {
                          message += '\n'+'Line ID: '+lineId;
                        }    
  
    if (cellvalue == '‚úÖ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' || cellvalue == 'üö´‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' ) {
      
      sendLineNotify(message, tokenE);
      sendLineNotify(message, token2);
    
      if(cellvalue == '‚úÖ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'){
        // calendar.createEvent(titles, startDate, endDate, {description: descriptions});
        
        if(res!==null)calendar.createAllDayEvent('üó∫Ô∏è‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô: '+name, date, {description: descriptions});
        var res = rng.createTextFinder('‡∏†‡∏±‡∏ï‡∏ï‡∏≤‡∏´‡∏≤‡∏£').findNext();
        if(res!==null)calendar.createAllDayEvent('üç±‡∏†‡∏±‡∏ï‡∏ï‡∏≤‡∏´‡∏≤‡∏£: '+name, date, {description: descriptions});
        var res = rng.createTextFinder('‡∏¢‡∏≤').findNext();
        if(res!==null)calendar.createAllDayEvent('üíä‡∏¢‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÇ‡∏£‡∏Ñ: '+name, date, {description: descriptions});
        var res = rng.createTextFinder('‡πÑ‡∏ó‡∏¢‡∏ò‡∏£‡∏£‡∏°').findNext();
        if(res!==null)calendar.createAllDayEvent('üéÅ‡πÑ‡∏ó‡∏¢‡∏ò‡∏£‡∏£‡∏°: '+name, date, {description: descriptions});
        var res = rng.createTextFinder('‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ').findNext();
        if(res!==null)calendar.createAllDayEvent('üåª‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ: '+name, date, {description: descriptions});
        var res = rng.createTextFinder('‡∏õ‡∏≤‡∏ô‡∏∞').findNext();
        if(res!==null)calendar.createAllDayEvent('üßÉ‡∏õ‡∏≤‡∏ô‡∏∞: '+name, date, {description: descriptions});
        
      }
    }
}
